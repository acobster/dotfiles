#!/bin/sh

usage() {
  echo "usage: $(basename $0) [-h|--help] COMMAND"
  echo
  echo '  COMMANDS:'
  echo
  echo '  home'
  echo '    Build the home-manager environment'
  echo
  echo '  system'
  echo '    Build the system configuration for the current host'
  echo
  echo '  up[date]'
  echo '    Update system dependencies'
  echo
  echo '  OPTIONS:'
  echo
  echo '  -h|--help show this help text'
}

POSITIONAL=()
while [[ $# -gt 0 ]]
do
key="$1"

case $key in
  -h|--help)
    # show usage and bail
    usage
    exit
    ;;

  up | update | system | home)
    COMMAND=$1
    shift # past argument
    ;;

  *)
    POSITIONAL+=("$1") # save it in an array for later
    shift # past argument
    ;;
esac

done
set -- "${POSITIONAL[@]}" # restore positional parameters


main() {
  local dotfiles_dir="$(dirname $(dirname $0))"
  case $COMMAND in
    up | update)
      sudo nix flake update
    ;;
    system)
      # `/#` defaults to hostname
      sudo nixos-rebuild switch --flake "$dotfiles_dir/#"
    ;;
    home)
      home-manager switch --flake "$dotfiles_dir/#tamayo"
    ;;
    *)
      usage
      exit 1
    ;;
  esac
}


main "$@"
