#!/usr/bin/env bash

if [[ -z $1 ]] ; then
  echo 'no pipe name specified; defaulting to "test.pipe"'
fi

pipe=${1:-'test.pipe'}

trap '[[ -p "$pipe" ]] && rm -f "$pipe" && echo "Bye bye!"' EXIT     # ignore exit and delete messages until the end

if [[ ! -p $pipe ]]; then   # if the pipe doesn't exist, create it
    mkfifo $pipe
fi
if [[ ! -p $pipe ]]; then   # if the pipe previously existed and is not a pipe, bail
    echo "$pipe" is not a pipe!
    exit 1
fi

while true                  # cycle eternally..
do
    if read line < $pipe; then
        echo
        echo "+ $line"
        # run the line
        bash -c "$line; echo = \$? ; `exit`"
    fi
done
